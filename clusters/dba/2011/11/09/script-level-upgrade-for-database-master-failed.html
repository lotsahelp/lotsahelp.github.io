<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Script level upgrade for database ‘master’ failed | Your awesome title</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Script level upgrade for database ‘master’ failed" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A few weeks ago one of our clustered server nodes blue-screened and when it came back on SQL refused to start. I started digging in and this is what I found in the Event Log: &quot;Script level upgrade for database &#39;master&#39; failed because upgrade step &#39;sqlagent100_msdb_upgrade.sql&#39; encountered error 200, state 7, severity 25.&quot; Immediately I started to suspect a corrupt master database. And I found this in the SQL Error Log: Creating procedure sp_sqlagent_get_perf_counters... Error: 468, Severity: 16, State: 9. Cannot resolve the collation conflict between &quot;SQL_Latin1_General_CP1_CI_AS&quot; and &quot;Latin1_General_CI_AS&quot; in the equal to operation. Error: 912, Severity: 21, State: 2. Script level upgrade for database &#39;master&#39; failed because upgrade step &#39;sqlagent100_msdb_upgrade.sql&#39; encountered error 200, state 7, severity 25. This is a serious error condition which might interfere with regular operation and the database will be taken offline. If the error happened during upgrade of the &#39;master&#39; database, it will prevent the entire SQL Server instance from starting. Examine the previous errorlog entries for errors, take the appropriate corrective actions and re-start the database so that the script upgrade steps run to completion. Error: 3417, Severity: 21, State: 3. Cannot recover the master database. SQL Server is unable to run. Restore master from a full backup, repair it, or rebuild it. For more information about how to rebuild the master database, see SQL Server Books Online. SQL Trace was stopped due to server shutdown. Trace ID = &#39;1&#39;. This is an informational message only; preser action is required. It turns out that the collation of msdb did not match master. Master was using SQL_Latin1_General_CP1_CI_AS while only msdb and one other database was using&nbsp;&nbsp;Latin1_General_CI_AS. The upgrade script that SQL Server ran at startup performed a join across those two databases resulting in the error. I&#39;m still not sure about why this script got run as no service packs / cumulative updates had been applied to this server recently&nbsp;and it was originally installed as 2008, not an upgrade from 2005. With the upgrade script interrupted, it left the master db unusable. I started going through the steps to restore master.&nbsp;I was able to start the server in single user mode, yet I could never get in as the single user. Something seemed to always be taking the connection before I could get in. I had a long, long conversation with the #sqlhelp folks on Twitter about this. All of these guys and gals were tossing out help:&nbsp;@sqlinsaneo @kbriankelly @darrelllandrum @rusanu @DBArgenis @Kendra_Little @mrdenny @Bugboi @SQLSoldier. We stopped all services that were known to connect, stopped the browser service, changed the port, only allow IP connections, paused the cluster node I was working on, and still I was getting an error that only one admin was allowed at a time in single user mode. Since I was getting nowhere fast, I decided on a different tact, namely to rebuild master then recover from backup. Rebuilding master was a fairly quick process. An important note about rebuilding master is that is also rebuilds msdb. Now I had two databases to recover from backup. Once the rebuild was complete, I was successfully able to&nbsp;start the service in single user mode &nbsp;and was able to connect (yay!!!). Now I could restore a backup of master, restart SQL normally and restore msdb. I finally had a running instance 2.5 hours later. Important lessons learned from this experience: If single user mode isn&#39;t working and you have a good backup of msdb, rebuild then recover. Rebuilding might fix some issues and get you on the road to recovery quicker. Collations of all the system databases really should match. This whole issue was because of a collation conflict between master and msdb. Thanks again to: Allen Kinsel (blog | twitter) K. Brian Kelley (blog | twitter) Darrell Landrum (twitter) Remus Rusanu (blog | twitter) Argenis Fernandez (blog | twitter) Kendra Little (blog | twitter) Denny Cherry (blog | twitter) Bugboi (twitter) Robert Davis (blog | twitter)" />
<meta property="og:description" content="A few weeks ago one of our clustered server nodes blue-screened and when it came back on SQL refused to start. I started digging in and this is what I found in the Event Log: &quot;Script level upgrade for database &#39;master&#39; failed because upgrade step &#39;sqlagent100_msdb_upgrade.sql&#39; encountered error 200, state 7, severity 25.&quot; Immediately I started to suspect a corrupt master database. And I found this in the SQL Error Log: Creating procedure sp_sqlagent_get_perf_counters... Error: 468, Severity: 16, State: 9. Cannot resolve the collation conflict between &quot;SQL_Latin1_General_CP1_CI_AS&quot; and &quot;Latin1_General_CI_AS&quot; in the equal to operation. Error: 912, Severity: 21, State: 2. Script level upgrade for database &#39;master&#39; failed because upgrade step &#39;sqlagent100_msdb_upgrade.sql&#39; encountered error 200, state 7, severity 25. This is a serious error condition which might interfere with regular operation and the database will be taken offline. If the error happened during upgrade of the &#39;master&#39; database, it will prevent the entire SQL Server instance from starting. Examine the previous errorlog entries for errors, take the appropriate corrective actions and re-start the database so that the script upgrade steps run to completion. Error: 3417, Severity: 21, State: 3. Cannot recover the master database. SQL Server is unable to run. Restore master from a full backup, repair it, or rebuild it. For more information about how to rebuild the master database, see SQL Server Books Online. SQL Trace was stopped due to server shutdown. Trace ID = &#39;1&#39;. This is an informational message only; preser action is required. It turns out that the collation of msdb did not match master. Master was using SQL_Latin1_General_CP1_CI_AS while only msdb and one other database was using&nbsp;&nbsp;Latin1_General_CI_AS. The upgrade script that SQL Server ran at startup performed a join across those two databases resulting in the error. I&#39;m still not sure about why this script got run as no service packs / cumulative updates had been applied to this server recently&nbsp;and it was originally installed as 2008, not an upgrade from 2005. With the upgrade script interrupted, it left the master db unusable. I started going through the steps to restore master.&nbsp;I was able to start the server in single user mode, yet I could never get in as the single user. Something seemed to always be taking the connection before I could get in. I had a long, long conversation with the #sqlhelp folks on Twitter about this. All of these guys and gals were tossing out help:&nbsp;@sqlinsaneo @kbriankelly @darrelllandrum @rusanu @DBArgenis @Kendra_Little @mrdenny @Bugboi @SQLSoldier. We stopped all services that were known to connect, stopped the browser service, changed the port, only allow IP connections, paused the cluster node I was working on, and still I was getting an error that only one admin was allowed at a time in single user mode. Since I was getting nowhere fast, I decided on a different tact, namely to rebuild master then recover from backup. Rebuilding master was a fairly quick process. An important note about rebuilding master is that is also rebuilds msdb. Now I had two databases to recover from backup. Once the rebuild was complete, I was successfully able to&nbsp;start the service in single user mode &nbsp;and was able to connect (yay!!!). Now I could restore a backup of master, restart SQL normally and restore msdb. I finally had a running instance 2.5 hours later. Important lessons learned from this experience: If single user mode isn&#39;t working and you have a good backup of msdb, rebuild then recover. Rebuilding might fix some issues and get you on the road to recovery quicker. Collations of all the system databases really should match. This whole issue was because of a collation conflict between master and msdb. Thanks again to: Allen Kinsel (blog | twitter) K. Brian Kelley (blog | twitter) Darrell Landrum (twitter) Remus Rusanu (blog | twitter) Argenis Fernandez (blog | twitter) Kendra Little (blog | twitter) Denny Cherry (blog | twitter) Bugboi (twitter) Robert Davis (blog | twitter)" />
<link rel="canonical" href="/clusters/dba/2011/11/09/script-level-upgrade-for-database-master-failed.html" />
<meta property="og:url" content="/clusters/dba/2011/11/09/script-level-upgrade-for-database-master-failed.html" />
<meta property="og:site_name" content="Your awesome title" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-11-09T10:17:04-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Script level upgrade for database ‘master’ failed" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"/clusters/dba/2011/11/09/script-level-upgrade-for-database-master-failed.html","headline":"Script level upgrade for database ‘master’ failed","dateModified":"2011-11-09T10:17:04-06:00","datePublished":"2011-11-09T10:17:04-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"/clusters/dba/2011/11/09/script-level-upgrade-for-database-master-failed.html"},"description":"A few weeks ago one of our clustered server nodes blue-screened and when it came back on SQL refused to start. I started digging in and this is what I found in the Event Log: &quot;Script level upgrade for database &#39;master&#39; failed because upgrade step &#39;sqlagent100_msdb_upgrade.sql&#39; encountered error 200, state 7, severity 25.&quot; Immediately I started to suspect a corrupt master database. And I found this in the SQL Error Log: Creating procedure sp_sqlagent_get_perf_counters... Error: 468, Severity: 16, State: 9. Cannot resolve the collation conflict between &quot;SQL_Latin1_General_CP1_CI_AS&quot; and &quot;Latin1_General_CI_AS&quot; in the equal to operation. Error: 912, Severity: 21, State: 2. Script level upgrade for database &#39;master&#39; failed because upgrade step &#39;sqlagent100_msdb_upgrade.sql&#39; encountered error 200, state 7, severity 25. This is a serious error condition which might interfere with regular operation and the database will be taken offline. If the error happened during upgrade of the &#39;master&#39; database, it will prevent the entire SQL Server instance from starting. Examine the previous errorlog entries for errors, take the appropriate corrective actions and re-start the database so that the script upgrade steps run to completion. Error: 3417, Severity: 21, State: 3. Cannot recover the master database. SQL Server is unable to run. Restore master from a full backup, repair it, or rebuild it. For more information about how to rebuild the master database, see SQL Server Books Online. SQL Trace was stopped due to server shutdown. Trace ID = &#39;1&#39;. This is an informational message only; preser action is required. It turns out that the collation of msdb did not match master. Master was using SQL_Latin1_General_CP1_CI_AS while only msdb and one other database was using&nbsp;&nbsp;Latin1_General_CI_AS. The upgrade script that SQL Server ran at startup performed a join across those two databases resulting in the error. I&#39;m still not sure about why this script got run as no service packs / cumulative updates had been applied to this server recently&nbsp;and it was originally installed as 2008, not an upgrade from 2005. With the upgrade script interrupted, it left the master db unusable. I started going through the steps to restore master.&nbsp;I was able to start the server in single user mode, yet I could never get in as the single user. Something seemed to always be taking the connection before I could get in. I had a long, long conversation with the #sqlhelp folks on Twitter about this. All of these guys and gals were tossing out help:&nbsp;@sqlinsaneo @kbriankelly @darrelllandrum @rusanu @DBArgenis @Kendra_Little @mrdenny @Bugboi @SQLSoldier. We stopped all services that were known to connect, stopped the browser service, changed the port, only allow IP connections, paused the cluster node I was working on, and still I was getting an error that only one admin was allowed at a time in single user mode. Since I was getting nowhere fast, I decided on a different tact, namely to rebuild master then recover from backup. Rebuilding master was a fairly quick process. An important note about rebuilding master is that is also rebuilds msdb. Now I had two databases to recover from backup. Once the rebuild was complete, I was successfully able to&nbsp;start the service in single user mode &nbsp;and was able to connect (yay!!!). Now I could restore a backup of master, restart SQL normally and restore msdb. I finally had a running instance 2.5 hours later. Important lessons learned from this experience: If single user mode isn&#39;t working and you have a good backup of msdb, rebuild then recover. Rebuilding might fix some issues and get you on the road to recovery quicker. Collations of all the system databases really should match. This whole issue was because of a collation conflict between master and msdb. Thanks again to: Allen Kinsel (blog | twitter) K. Brian Kelley (blog | twitter) Darrell Landrum (twitter) Remus Rusanu (blog | twitter) Argenis Fernandez (blog | twitter) Kendra Little (blog | twitter) Denny Cherry (blog | twitter) Bugboi (twitter) Robert Davis (blog | twitter)","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Your awesome title" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Your awesome title</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/about/">About</a><a class="page-link" href="/contact-me/">Contact Me</a><a class="page-link" href="/privacy-policy/">Privacy Policy</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Script level upgrade for database &#39;master&#39; failed</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2011-11-09T10:17:04-06:00" itemprop="datePublished">Nov 9, 2011
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">{"display_name"=>"lotsahelp", "login"=>"lotsahelp", "email"=>"eric@erichumphrey.com", "url"=>""}</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>A few weeks ago one of our clustered server nodes blue-screened and when it came back on SQL refused to start. I started digging in and this is what I found in the Event Log: "Script level upgrade for database 'master' failed because upgrade step 'sqlagent100_msdb_upgrade.sql' encountered error 200, state 7, severity 25." Immediately I started to suspect a corrupt master database. And I found this in the SQL Error Log:</p>
<blockquote><p>Creating procedure sp_sqlagent_get_perf_counters...<br />
Error: 468, Severity: 16, State: 9.<br />
<strong>Cannot resolve the collation conflict between "SQL_Latin1_General_CP1_CI_AS" and "Latin1_General_CI_AS" in the equal to operation.</strong><br />
Error: 912, Severity: 21, State: 2.<br />
Script level upgrade for database 'master' failed because upgrade step 'sqlagent100_msdb_upgrade.sql' encountered error 200, state 7, severity 25. This is a serious error condition which might interfere with regular operation and the database will be taken offline. If the error happened during upgrade of the 'master' database, it will prevent the entire SQL Server instance from starting. Examine the previous errorlog entries for errors, take the appropriate corrective actions and re-start the database so that the script upgrade steps run to completion.<br />
Error: 3417, Severity: 21, State: 3.<br />
Cannot recover the master database. SQL Server is unable to run. Restore master from a full backup, repair it, or rebuild it. For more information about how to rebuild the master database, see SQL Server Books Online.<br />
SQL Trace was stopped due to server shutdown. Trace ID = '1'. This is an informational message only; preser action is required.</p></blockquote>
<p>It turns out that the collation of msdb did not match master. Master was using SQL_Latin1_General_CP1_CI_AS while only msdb and one other database was using&nbsp;&nbsp;Latin1_General_CI_AS. The upgrade script that SQL Server ran at startup performed a join across those two databases resulting in the error. I'm still not sure about why this script got run as no service packs / cumulative updates had been applied to this server recently&nbsp;and it was originally installed as 2008, not an upgrade from 2005. With the upgrade script interrupted, it left the master db unusable.</p>
<p>I started going through the <a href="http://msdn.microsoft.com/en-us/library/ms190679.aspx">steps to restore master</a>.&nbsp;I was able to <a href="http://msdn.microsoft.com/en-us/library/ms188236%28v=sql.100%29.aspx">start the server in single user mode</a>, yet I could never get in as the single user. Something seemed to always be taking the connection before I could get in.</p>
<p>I had a long, long conversation with the #sqlhelp folks on Twitter about this. All of these guys and gals were tossing out help:&nbsp;@sqlinsaneo @kbriankelly @darrelllandrum @rusanu @DBArgenis @Kendra_Little @mrdenny @Bugboi @SQLSoldier. We stopped all services that were known to connect, stopped the browser service, changed the port, only allow IP connections, paused the cluster node I was working on, and still I was getting an error that only one admin was allowed at a time in single user mode.</p>
<p>Since I was getting nowhere fast, I decided on a different tact, namely to <a href="https://blogs.msdn.com/themes/blogs/generic/post.aspx?WeblogApp=psssql&amp;y=2008&amp;m=08&amp;d=29&amp;WeblogPostName=how-to-rebuild-system-databases-in-sql-server-2008&amp;GroupKeys=">rebuild master</a> then recover from backup. Rebuilding master was a fairly quick process. An important note about rebuilding master is that is also rebuilds msdb. Now I had two databases to recover from backup. Once the rebuild was complete, I was successfully able to&nbsp;start the service in single user mode &nbsp;and was able to connect (yay!!!). Now I could restore a backup of master, restart SQL normally and restore msdb. I finally had a running instance 2.5 hours later.</p>
<p>Important lessons learned from this experience:</p>
<ul>
<li>If single user mode isn't working and you have a good backup of msdb, rebuild then recover. Rebuilding might fix some issues and get you on the road to recovery quicker.</li>
<li>Collations of all the system databases really should match. This whole issue was because of a collation conflict between master and msdb.</li>
</ul>
<div>Thanks again to:</div>
<div>
<ul>
<li>Allen Kinsel (<a href="http://www.allenkinsel.com">blog</a> | <a href="http://twitter.com/#!/sqlinsaneo">twitter</a>)</li>
<li>K. Brian Kelley (<a href="http://www.truthsolutions.com">blog</a> | <a href="http://twitter.com/#!/kbriankelley">twitter</a>)</li>
<li>Darrell Landrum (<a href="http://twitter.com/#!/darrelllandrum">twitter</a>)</li>
<li>Remus Rusanu (<a href="http://rusanu.com">blog</a> | <a href="http://twitter.com/#!/rusanu">twitter</a>)</li>
<li>Argenis Fernandez (<a href="http://www.sqlblog.com/blogs/argenis_fernandez">blog</a> | <a href="http://twitter.com/#!/DBArgenis">twitter</a>)</li>
<li>Kendra Little (<a href="http://littlekendra.com">blog</a> | <a href="http://twitter.com/#!/Kendra_Little">twitter</a>)</li>
<li>Denny Cherry (<a href="http://www.mrdenny.com">blog</a> | <a href="http://twitter.com/#!/mrdenny">twitter</a>)</li>
<li>Bugboi (<a href="http://twitter.com/#!/Bugboi">twitter</a>)</li>
<li>Robert Davis (<a href="http://www.sqlsoldier.com">blog</a> | <a href="http://twitter.com/#!/SQLSoldier">twitter</a>)</li>
</ul>
</div>

  </div><a class="u-url" href="/clusters/dba/2011/11/09/script-level-upgrade-for-database-master-failed.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Your awesome title</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Your awesome title</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
