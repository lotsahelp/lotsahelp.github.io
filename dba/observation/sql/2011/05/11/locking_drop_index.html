<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Locking While Dropping or Altering an Index | Your awesome title</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Locking While Dropping or Altering an Index" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Yesterday I was trying to drop some hypothetical indexes in production against a fairly active table. I started causing blocking so I had the bright idea of disabling the indexes first, then dropping. Well, that didn&#39;t help, even when setting DEADLOCK_PRIORITY to LOW. I ended up waiting until early morning to remove those indexes to prevent from blocking other users. Finding no info on the web about the locks taken during the process of dropping or disabling an index, I set about doing this small bit of research. The queries I used: In Window 1 (Execute first) BEGIN TRAN SELECT TOP 100 * FROM myTable WITH (TABLOCKX) * I use TABLOCKX to simulate many updates going to this table. In Window 2 DROP INDEX [ix_myTable_testIndex] ON myTable Using Adam Machanic&#39;s (blog | twitter) sp_WhoIsActive I was able to get the lock details easily. sp_whoisactive @get_locks = 1 When you disable an index, you end up trying to acquire a Sch-M or Schema Modification lock. Then the next select query comes along and trys to grab an IS or Intent Shared lock So at this point yesterday, I was thinking, maybe I can disable the index and then drop it. Well, ALTER INDEX ... DISABLE also waits on a Sch-M lock before it can proceed. I&#39;m not any better off. Even after the disabling the index, SQL Server still tries to grab a Sch-M lock to drop the disabled index. All these rules also seem to apply to hypothetical indexes. I&#39;m sure there&#39;s some internals reason why it does this, but why worry about locks when dropping a disabled or hypothetical index since neither are used by active queries? Lesson learned, drop indexes when the table usage is low. *Update [qtweet 68491945105821696]" />
<meta property="og:description" content="Yesterday I was trying to drop some hypothetical indexes in production against a fairly active table. I started causing blocking so I had the bright idea of disabling the indexes first, then dropping. Well, that didn&#39;t help, even when setting DEADLOCK_PRIORITY to LOW. I ended up waiting until early morning to remove those indexes to prevent from blocking other users. Finding no info on the web about the locks taken during the process of dropping or disabling an index, I set about doing this small bit of research. The queries I used: In Window 1 (Execute first) BEGIN TRAN SELECT TOP 100 * FROM myTable WITH (TABLOCKX) * I use TABLOCKX to simulate many updates going to this table. In Window 2 DROP INDEX [ix_myTable_testIndex] ON myTable Using Adam Machanic&#39;s (blog | twitter) sp_WhoIsActive I was able to get the lock details easily. sp_whoisactive @get_locks = 1 When you disable an index, you end up trying to acquire a Sch-M or Schema Modification lock. Then the next select query comes along and trys to grab an IS or Intent Shared lock So at this point yesterday, I was thinking, maybe I can disable the index and then drop it. Well, ALTER INDEX ... DISABLE also waits on a Sch-M lock before it can proceed. I&#39;m not any better off. Even after the disabling the index, SQL Server still tries to grab a Sch-M lock to drop the disabled index. All these rules also seem to apply to hypothetical indexes. I&#39;m sure there&#39;s some internals reason why it does this, but why worry about locks when dropping a disabled or hypothetical index since neither are used by active queries? Lesson learned, drop indexes when the table usage is low. *Update [qtweet 68491945105821696]" />
<link rel="canonical" href="/dba/observation/sql/2011/05/11/locking_drop_index.html" />
<meta property="og:url" content="/dba/observation/sql/2011/05/11/locking_drop_index.html" />
<meta property="og:site_name" content="Your awesome title" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-05-11T19:19:04-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Locking While Dropping or Altering an Index" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"/dba/observation/sql/2011/05/11/locking_drop_index.html","headline":"Locking While Dropping or Altering an Index","dateModified":"2011-05-11T19:19:04-05:00","datePublished":"2011-05-11T19:19:04-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"/dba/observation/sql/2011/05/11/locking_drop_index.html"},"description":"Yesterday I was trying to drop some hypothetical indexes in production against a fairly active table. I started causing blocking so I had the bright idea of disabling the indexes first, then dropping. Well, that didn&#39;t help, even when setting DEADLOCK_PRIORITY to LOW. I ended up waiting until early morning to remove those indexes to prevent from blocking other users. Finding no info on the web about the locks taken during the process of dropping or disabling an index, I set about doing this small bit of research. The queries I used: In Window 1 (Execute first) BEGIN TRAN SELECT TOP 100 * FROM myTable WITH (TABLOCKX) * I use TABLOCKX to simulate many updates going to this table. In Window 2 DROP INDEX [ix_myTable_testIndex] ON myTable Using Adam Machanic&#39;s (blog | twitter) sp_WhoIsActive I was able to get the lock details easily. sp_whoisactive @get_locks = 1 When you disable an index, you end up trying to acquire a Sch-M or Schema Modification lock. Then the next select query comes along and trys to grab an IS or Intent Shared lock So at this point yesterday, I was thinking, maybe I can disable the index and then drop it. Well, ALTER INDEX ... DISABLE also waits on a Sch-M lock before it can proceed. I&#39;m not any better off. Even after the disabling the index, SQL Server still tries to grab a Sch-M lock to drop the disabled index. All these rules also seem to apply to hypothetical indexes. I&#39;m sure there&#39;s some internals reason why it does this, but why worry about locks when dropping a disabled or hypothetical index since neither are used by active queries? Lesson learned, drop indexes when the table usage is low. *Update [qtweet 68491945105821696]","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Your awesome title" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Your awesome title</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/about/">About</a><a class="page-link" href="/contact-me/">Contact Me</a><a class="page-link" href="/privacy-policy/">Privacy Policy</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Locking While Dropping or Altering an Index</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2011-05-11T19:19:04-05:00" itemprop="datePublished">May 11, 2011
      </time>â€¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">{"display_name"=>"lotsahelp", "login"=>"lotsahelp", "email"=>"eric@erichumphrey.com", "url"=>""}</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Yesterday I was trying to drop some hypothetical indexes in production against a fairly active table. I started causing blocking so I had the bright idea of disabling the indexes first, then dropping. Well, that didn't help, even when setting DEADLOCK_PRIORITY to LOW. I ended up waiting until early morning to remove those indexes to prevent from blocking other users.</p>
<p>Finding no info on the web about the locks taken during the process of dropping or disabling an index, I set about doing this small bit of research.</p>
<p>The queries I used:<br />
In Window 1 (Execute first)</p>
<pre lang="tsql">BEGIN TRAN
SELECT TOP 100 * FROM myTable WITH (TABLOCKX)</pre>
<p>* I use TABLOCKX to simulate many updates going to this table.</p>
<p>In Window 2</p>
<pre lang="tsql">DROP INDEX [ix_myTable_testIndex] ON myTable</pre>
<p>Using Adam Machanic's (<a href="http://sqlblog.com/blogs/adam_machanic/">blog</a> | <a href="http://twitter.com/#!/AdamMachanic">twitter</a>) <a href="http://sqlblog.com/blogs/adam_machanic/archive/tags/who+is+active/">sp_WhoIsActive</a> I was able to get the lock details easily.</p>
<pre lang="tsql">sp_whoisactive @get_locks = 1</pre>
<p>When you disable an index, you end up trying to acquire a Sch-M or Schema Modification lock. </p>
<pre lang="xml"><Database name="Sandbox">
  <Locks>
    <Lock request_mode="S" request_status="GRANT" request_count="1" />
  </Locks>
  <Objects>
    <object name="myTable" schema_name="dbo">
      <Locks>
        <Lock resource_type="OBJECT" request_mode="Sch-M" request_status="WAIT" request_count="1" />
      </Locks>
    </object>
  </Objects>
</Database></pre>
<p>Then the next select query comes along and trys to grab an IS or Intent Shared lock</p>
<pre lang="xml"><Database name="Sandbox">
  <Locks>
    <Lock request_mode="S" request_status="GRANT" request_count="1" />
  </Locks>
  <Objects>
    <object name="myTable" schema_name="dbo">
      <Locks>
        <Lock resource_type="OBJECT" request_mode="IS" request_status="WAIT" request_count="1" />
      </Locks>
    </object>
  </Objects>
</Database></pre>
<p>So at this point yesterday, I was thinking, maybe I can disable the index and then drop it. Well, ALTER INDEX ... DISABLE also waits on a Sch-M lock before it can proceed. I'm not any better off. Even after the disabling the index, SQL Server still tries to grab a Sch-M lock to drop the disabled index. All these rules also seem to apply to hypothetical indexes. I'm sure there's some internals reason why it does this, but why worry about locks when dropping a disabled or hypothetical index since neither are used by active queries?</p>
<p>Lesson learned, drop indexes when the table usage is low.</p>
<p><strong>*Update</strong><br />
[qtweet 68491945105821696]</p>

  </div><a class="u-url" href="/dba/observation/sql/2011/05/11/locking_drop_index.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Your awesome title</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Your awesome title</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
